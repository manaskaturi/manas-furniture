<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DEMO Furniture Studio ‚Äî Vijayawada</title>
<style>
:root {
  --bg: #ffffff;
  --muted: #6b7280;
  --text: #0f172a;
  --accent: #0ea5e9;
  --accent2: #06b6d4;
  --surface: #fafbfc;
  --border: rgba(15, 23, 42, 0.08);
  --shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
  --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.12);
}

* {
  box-sizing: border-box;
}

html, body {
  height: 100%;
  margin: 0;
  background: var(--bg);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  color: var(--text);
}

/* Header */
header {
  position: fixed;
  left: 0;
  right: 0;
  top: 0;
  height: 64px;
  background: rgba(250, 251, 252, 0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  border-bottom: 1px solid var(--border);
  z-index: 1000;
}

.brand {
  font-weight: 700;
  letter-spacing: -0.02em;
  font-size: 18px;
}

.sub {
  font-size: 13px;
  color: var(--muted);
  font-weight: 500;
}

.header-right {
  font-weight: 600;
  color: var(--muted);
  font-size: 14px;
}

/* Main camera area */
#cameraWrapper {
  position: fixed;
  left: 0;
  right: 0;
  top: 64px;
  bottom: 0;
  background: #f8fafc;
  overflow: hidden;
}

#bgImage {
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: none;
  z-index: 5;
}

video#camera {
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  z-index: 5;
  background: #000;
  display: block;
}

canvas#grid {
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 15;
}

#overlay {
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  z-index: 10;
  pointer-events: none;
}

/* Controls */
#controls {
  position: fixed;
  right: 20px;
  bottom: 20px;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  z-index: 1100;
}

.btn {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: 12px;
  padding: 12px 16px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  color: var(--text);
  transition: all 0.2s ease;
  white-space: nowrap;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.btn.primary {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: white;
  border: 0;
}

.btn.primary:hover {
  background: linear-gradient(135deg, #0284c7, #0891b2);
}

/* Catalog toggle */
#catalogToggle {
  position: fixed;
  left: 20px;
  bottom: 20px;
  padding: 12px 16px;
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  cursor: pointer;
  z-index: 1100;
  font-weight: 600;
  color: var(--text);
  transition: all 0.2s ease;
}

#catalogToggle:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

/* Catalog drawer */
#catalogDrawer {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  height: 300px;
  max-height: 50vh;
  background: rgba(250, 251, 252, 0.98);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-top: 1px solid var(--border);
  box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.1);
  transform: translateY(100%);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 1200;
  padding: 16px;
  display: flex;
  flex-direction: column;
}

#catalogDrawer.open {
  transform: translateY(0);
}

#catalogHead {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

#catalogHead h3 {
  margin: 0;
  font-weight: 700;
  font-size: 16px;
}

.catalog-actions {
  display: flex;
  gap: 8px;
}

#catalogList {
  display: flex;
  gap: 12px;
  overflow-x: auto;
  padding-bottom: 8px;
}

.catalog-item {
  min-width: 120px;
  max-width: 130px;
  padding: 12px;
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.7);
  border: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.catalog-item:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow);
  background: rgba(255, 255, 255, 0.9);
}

.catalog-thumb {
  width: 80px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 8px;
}

.catalog-thumb img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

.catalog-label {
  font-weight: 600;
  font-size: 12px;
  text-align: center;
  margin-bottom: 4px;
}

.catalog-sub {
  font-size: 10px;
  color: var(--muted);
  text-align: center;
}

/* Items on scene */
.item-wrap {
  position: absolute;
  left: 0;
  top: 0;
  transform-origin: center center;
  will-change: transform;
  z-index: 50;
  user-select: none;
  pointer-events: auto;
  cursor: move;
}

.item-wrap.selected {
  z-index: 100;
}

.item-wrap.selected::after {
  content: '';
  position: absolute;
  left: -8px;
  top: -8px;
  right: -8px;
  bottom: -8px;
  border: 2px solid var(--accent);
  border-radius: 8px;
  pointer-events: none;
  z-index: -1;
}

.item-img {
  display: block;
  pointer-events: none;
  max-width: 400px;
  border-radius: 4px;
}

/* Handles */
.handle {
  position: absolute;
  width: 14px;
  height: 14px;
  background: var(--accent);
  border: 2px solid white;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  box-shadow: var(--shadow);
  opacity: 0;
  transition: opacity 0.2s ease;
  z-index: 200;
}

.item-wrap.selected .handle {
  opacity: 1;
}

.handle.nw { left: 0; top: 0; cursor: nw-resize; }
.handle.ne { right: 0; top: 0; cursor: ne-resize; }
.handle.sw { left: 0; bottom: 0; cursor: sw-resize; }
.handle.se { right: 0; bottom: 0; cursor: se-resize; }
.handle.n { left: 50%; top: 0; cursor: n-resize; }
.handle.s { left: 50%; bottom: 0; cursor: s-resize; }
.handle.e { right: 0; top: 50%; cursor: e-resize; }
.handle.w { left: 0; top: 50%; cursor: w-resize; }

.handle.rotate {
  top: -30px;
  left: 50%;
  width: 16px;
  height: 16px;
  background: var(--accent2);
  cursor: grab;
}

.handle.rotate:active {
  cursor: grabbing;
}

/* Item toolbar */
.item-toolbar {
  position: absolute;
  right: 0;
  top: -50px;
  display: flex;
  gap: 6px;
  opacity: 0;
  transform: translateY(-8px);
  transition: all 0.2s ease;
  z-index: 300;
  pointer-events: none;
}

.item-wrap.selected .item-toolbar {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}

.tool {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  padding: 6px 10px;
  border-radius: 8px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  font-weight: 600;
  font-size: 11px;
  cursor: pointer;
  color: var(--text);
  transition: all 0.2s ease;
  white-space: nowrap;
}

.tool:hover {
  background: white;
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.tool.danger {
  color: #dc2626;
}

.tool.danger:hover {
  background: #fee2e2;
  color: #991b1b;
}

/* Responsive */
@media (max-width: 768px) {
  header {
    padding: 0 16px;
  }
  
  .brand {
    font-size: 16px;
  }
  
  #controls {
    right: 16px;
    bottom: 16px;
    gap: 8px;
  }
  
  .btn {
    padding: 10px 12px;
    font-size: 13px;
  }
  
  #catalogToggle {
    left: 16px;
    bottom: 16px;
  }
  
  #catalogDrawer {
    height: 280px;
  }
}

/* Hidden file inputs */
input[type="file"] {
  display: none;
}
</style>
</head>
<body>
  <header>
    <div>
      <div class="brand">DEMO Furniture Studio</div>
      <div class="sub">Vijayawada</div>
    </div>
    <div class="header-right">AR Try-On Prototype</div>
  </header>

  <div id="cameraWrapper">
    <img id="bgImage" alt="Background" />
    <video id="camera" autoplay muted playsinline></video>
    <canvas id="grid"></canvas>
    <div id="overlay"></div>
  </div>

  <div id="controls">
    <button class="btn primary" id="startCam">üì± Start Camera</button>
    <button class="btn" id="stopCam">‚èπÔ∏è Stop</button>
    
    <input id="fileBg" type="file" accept="image/*" />
    <button class="btn" id="uploadBg">üñºÔ∏è Background</button>
    
    <button class="btn" id="toggleCamBg">üì∑ Use Camera</button>
    
    <input id="fileFurniture" type="file" accept="image/*" />
    <button class="btn" id="uploadFurniture">üìÅ Upload Item</button>
    
    <button class="btn" id="toggleGridBtn">üìê Grid</button>
    <button class="btn" id="snapshotBtn">üì∏ Snapshot</button>
    <button class="btn danger" id="resetBtn">‚ôªÔ∏è Reset</button>

  </div>

  <div id="catalogToggle">üìö Catalog</div>

  <div id="catalogDrawer" aria-hidden="true">
    <div id="catalogHead">
      <h3>Furniture Catalog</h3>
      <div class="catalog-actions">
        <button class="btn" id="addSamples">‚ú® Add Samples</button>
        <button class="btn" id="closeCatalog">‚úï Close</button>
      </div>
    </div>
    <div id="catalogList"></div>
  </div>

<script>
// SVG furniture icons
const FURNITURE_ICONS = {
  "Modern Sofa": `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 640 320' fill='#1f2937'>
    <rect x='40' y='160' width='560' height='80' rx='16' fill='#374151'/>
    <rect x='80' y='120' width='180' height='60' rx='12' fill='#4b5563'/>
    <rect x='380' y='120' width='180' height='60' rx='12' fill='#4b5563'/>
    <rect x='60' y='240' width='16' height='30' rx='4' fill='#1f2937'/>
    <rect x='564' y='240' width='16' height='30' rx='4' fill='#1f2937'/>
  </svg>`,
  
  "Armchair": `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 360 360' fill='#1f2937'>
    <rect x='80' y='100' width='200' height='100' rx='16' fill='#374151'/>
    <rect x='60' y='200' width='24' height='70' rx='6' fill='#4b5563'/>
    <rect x='276' y='200' width='24' height='70' rx='6' fill='#4b5563'/>
    <rect x='100' y='270' width='12' height='20' rx='3' fill='#1f2937'/>
    <rect x='248' y='270' width='12' height='20' rx='3' fill='#1f2937'/>
  </svg>`,
  
  "Dining Table": `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 640 360' fill='#1f2937'>
    <ellipse cx='320' cy='140' rx='280' ry='20' fill='#374151'/>
    <rect x='100' y='160' width='16' height='120' rx='4' fill='#4b5563'/>
    <rect x='524' y='160' width='16' height='120' rx='4' fill='#4b5563'/>
    <rect x='200' y='160' width='16' height='120' rx='4' fill='#4b5563'/>
    <rect x='424' y='160' width='16' height='120' rx='4' fill='#4b5563'/>
  </svg>`,
  
  "King Bed": `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 720 360' fill='#1f2937'>
    <rect x='60' y='160' width='600' height='70' rx='12' fill='#374151'/>
    <rect x='80' y='130' width='200' height='50' rx='8' fill='#4b5563'/>
    <rect x='440' y='130' width='200' height='50' rx='8' fill='#4b5563'/>
    <rect x='60' y='230' width='600' height='24' rx='6' fill='#1f2937'/>
    <rect x='80' y='254' width='12' height='16' rx='3' fill='#1f2937'/>
    <rect x='628' y='254' width='12' height='16' rx='3' fill='#1f2937'/>
  </svg>`,
  
  "Floor Lamp": `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 240 480' fill='#1f2937'>
    <polygon points='120,40 200,140 40,140' fill='#fbbf24' opacity='0.8'/>
    <rect x='118' y='140' width='4' height='200' rx='2' fill='#4b5563'/>
    <ellipse cx='120' cy='350' rx='30' ry='6' fill='#374151'/>
  </svg>`,
  
  "Area Rug": `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 480 320' fill='#1f2937'>
    <rect x='40' y='40' width='400' height='240' rx='24' fill='#7c3aed' opacity='0.3'/>
    <rect x='60' y='60' width='360' height='200' rx='16' fill='#a855f7' opacity='0.4'/>
    <rect x='80' y='80' width='320' height='160' rx='12' fill='#c084fc' opacity='0.5'/>
  </svg>`,
  
  "Potted Plant": `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 300' fill='#1f2937'>
    <rect x='60' y='220' width='80' height='50' rx='6' fill='#8b4513'/>
    <ellipse cx='100' cy='200' rx='30' ry='40' fill='#22c55e'/>
    <ellipse cx='85' cy='180' rx='25' ry='30' fill='#16a34a'/>
    <ellipse cx='115' cy='185' rx='20' ry='35' fill='#15803d'/>
  </svg>`,
  
  "Coffee Table": `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 480 200' fill='#1f2937'>
    <ellipse cx='240' cy='60' rx='200' ry='16' fill='#374151'/>
    <rect x='100' y='76' width='12' height='80' rx='3' fill='#4b5563'/>
    <rect x='368' y='76' width='12' height='80' rx='3' fill='#4b5563'/>
  </svg>`
};

// DOM elements
const cameraWrapper = document.getElementById('cameraWrapper');
const camera = document.getElementById('camera');
const bgImage = document.getElementById('bgImage');
const overlay = document.getElementById('overlay');
const gridCanvas = document.getElementById('grid');

const startCam = document.getElementById('startCam');
const stopCam = document.getElementById('stopCam');
const uploadBg = document.getElementById('uploadBg');
const fileBg = document.getElementById('fileBg');
const toggleCamBg = document.getElementById('toggleCamBg');
const uploadFurniture = document.getElementById('uploadFurniture');
const fileFurniture = document.getElementById('fileFurniture');
const toggleGridBtn = document.getElementById('toggleGridBtn');
const snapshotBtn = document.getElementById('snapshotBtn');

const catalogToggle = document.getElementById('catalogToggle');
const catalogDrawer = document.getElementById('catalogDrawer');
const catalogList = document.getElementById('catalogList');
const closeCatalog = document.getElementById('closeCatalog');
const addSamples = document.getElementById('addSamples');

// State
let currentStream = null;
let gridVisible = false;
let useBackground = false;
let selectedItem = null;
let itemCounter = 0;

// Initialize catalog
function initCatalog() {
  catalogList.innerHTML = '';
  Object.entries(FURNITURE_ICONS).forEach(([name, svg]) => {
    const item = document.createElement('div');
    item.className = 'catalog-item';
    const dataUrl = `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
    
    item.innerHTML = `
      <div class="catalog-thumb">
        <img src="${dataUrl}" alt="${name}">
      </div>
      <div class="catalog-label">${name}</div>
      <div class="catalog-sub">Tap to add</div>
    `;
    
    item.addEventListener('click', () => {
      createFurnitureItem(dataUrl, name);
      // Optional: close catalog after adding item
      // catalogDrawer.classList.remove('open');
    });
    
    catalogList.appendChild(item);
  });
}

// Camera controls
startCam.addEventListener('click', async () => {
  try {
    if (currentStream) {
      currentStream.getTracks().forEach(track => track.stop());
    }
    
    currentStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment' },
      audio: false
    });
    
    camera.srcObject = currentStream;
    camera.style.display = useBackground ? 'none' : 'block';
    bgImage.style.display = useBackground ? 'block' : 'none';
    
    await camera.play();
    startCam.textContent = 'üì± Camera Active';
  } catch (err) {
    alert('Camera access failed: ' + (err.message || err));
  }
});

stopCam.addEventListener('click', () => {
  if (currentStream) {
    currentStream.getTracks().forEach(track => track.stop());
    currentStream = null;
    camera.srcObject = null;
    startCam.textContent = 'üì± Start Camera';
  }
});

// Background upload
uploadBg.addEventListener('click', () => fileBg.click());
fileBg.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  const url = URL.createObjectURL(file);
  bgImage.src = url;
  useBackground = true;
  bgImage.style.display = 'block';
  camera.style.display = 'none';
  toggleCamBg.textContent = 'üì∑ Use Camera';
  fileBg.value = '';
});

// Toggle camera/background
toggleCamBg.addEventListener('click', () => {
  useBackground = !useBackground;
  
  if (useBackground) {
    camera.style.display = 'none';
    bgImage.style.display = bgImage.src ? 'block' : 'none';
    toggleCamBg.textContent = 'üì∑ Use Camera';
  } else {
    camera.style.display = 'block';
    bgImage.style.display = 'none';
    toggleCamBg.textContent = 'üñºÔ∏è Use Background';
  }
});

// Furniture upload
uploadFurniture.addEventListener('click', () => fileFurniture.click());
fileFurniture.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  const url = URL.createObjectURL(file);
  createFurnitureItem(url, file.name);
  
  // Add to catalog
  addToCatalog(file.name, url);
  fileFurniture.value = '';
});

// Add uploaded item to catalog
function addToCatalog(name, src) {
  // Check if this item already exists in catalog
  const existingItems = Array.from(catalogList.children);
  const exists = existingItems.some(item => {
    const img = item.querySelector('img');
    return img && img.src === src;
  });
  
  if (exists) return; // Don't add duplicates to catalog
  
  const item = document.createElement('div');
  item.className = 'catalog-item';
  
  item.innerHTML = `
    <div class="catalog-thumb">
      <img src="${src}" alt="${name}">
    </div>
    <div class="catalog-label">${name}</div>
    <div class="catalog-sub">Custom Upload</div>
  `;
  
  item.addEventListener('click', () => {
    createFurnitureItem(src, name);
  });
  
  // Add to the end of catalog
  catalogList.appendChild(item);
}

// Grid functionality
function drawGrid(show) {
  const canvas = gridCanvas;
  const rect = cameraWrapper.getBoundingClientRect();
  canvas.width = rect.width;
  canvas.height = rect.height;
  
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  if (!show) return;
  
  const gridSize = 40;
  ctx.strokeStyle = 'rgba(15, 23, 42, 0.1)';
  ctx.lineWidth = 1;
  
  for (let x = 0; x < canvas.width; x += gridSize) {
    ctx.beginPath();
    ctx.moveTo(x, 0);
    ctx.lineTo(x, canvas.height);
    ctx.stroke();
  }
  
  for (let y = 0; y < canvas.height; y += gridSize) {
    ctx.beginPath();
    ctx.moveTo(0, y);
    ctx.lineTo(canvas.width, y);
    ctx.stroke();
  }
}

toggleGridBtn.addEventListener('click', () => {
  gridVisible = !gridVisible;
  drawGrid(gridVisible);
  toggleGridBtn.textContent = gridVisible ? 'üìê Grid: ON' : 'üìê Grid';
});
const resetBtn = document.getElementById('resetBtn');
resetBtn.addEventListener('click', () => {
  overlay.innerHTML = ''; // clear all items
  selectedItem = null;    // deselect everything
});

// Catalog controls
catalogToggle.addEventListener('click', () => {
  catalogDrawer.classList.add('open');
  catalogDrawer.setAttribute('aria-hidden', 'false');
});

closeCatalog.addEventListener('click', () => {
  catalogDrawer.classList.remove('open');
  catalogDrawer.setAttribute('aria-hidden', 'true');
});

// Add sample items
addSamples.addEventListener('click', () => {
  const items = Object.entries(FURNITURE_ICONS);
  items.forEach(([name, svg], index) => {
    const dataUrl = `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
    const item = createFurnitureItem(dataUrl, name);
    
    // Spread items out a bit
    const offsetX = (index - Math.floor(items.length / 2)) * 60;
    const offsetY = Math.abs(index - Math.floor(items.length / 2)) * 20;
    
    item.dataset.tx = offsetX;
    item.dataset.ty = offsetY;
    updateTransform(item);
  });
  
  catalogDrawer.classList.remove('open');
});

// Create furniture item
function createFurnitureItem(src, name) {
  itemCounter++;
  const wrapper = document.createElement('div');
  wrapper.className = 'item-wrap';
  wrapper.dataset.id = `item-${itemCounter}`;
  wrapper.dataset.name = name;
  
  // Position in center of camera wrapper
  const rect = cameraWrapper.getBoundingClientRect();
  const centerX = rect.width / 2;
  const centerY = rect.height / 2;
  
  wrapper.style.left = `${centerX}px`;
  wrapper.style.top = `${centerY}px`;
  
  // Transform data
  wrapper.dataset.tx = '0';
  wrapper.dataset.ty = '0';
  // back-compat and non-proportional support
  wrapper.dataset.scale = '1';
  wrapper.dataset.scaleX = '1';
  wrapper.dataset.scaleY = '1';
  wrapper.dataset.rotation = '0';
  
  // Create image
  const img = document.createElement('img');
  img.className = 'item-img';
  img.src = src;
  img.alt = name;
  img.style.width = '200px';
  img.style.height = 'auto';

  // store base dimensions once image is loaded so scaling is relative to this
  function setBaseDims() {
    const r = img.getBoundingClientRect();
    const baseW = r.width || parseFloat(img.style.width) || 200;
    const baseH = r.height || (img.naturalHeight ? baseW * (img.naturalHeight / img.naturalWidth) : baseW * 0.6);
    wrapper.dataset.baseWidth = baseW;
    wrapper.dataset.baseHeight = baseH;
  }
  if (img.complete) setBaseDims(); else img.addEventListener('load', setBaseDims);
  
  // Create handles
  const handles = ['nw', 'n', 'ne', 'w', 'e', 'sw', 's', 'se', 'rotate'];
  handles.forEach(pos => {
    const handle = document.createElement('div');
    handle.className = `handle ${pos}`;
    wrapper.appendChild(handle);
  });
  
  // Create toolbar
  const toolbar = document.createElement('div');
  toolbar.className = 'item-toolbar';
  
  const deleteBtn = document.createElement('button');
  deleteBtn.className = 'tool danger';
  deleteBtn.textContent = 'üóëÔ∏è Delete';
  deleteBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    wrapper.remove();
    if (selectedItem === wrapper) {
      selectedItem = null;
    }
  });
  
  const duplicateBtn = document.createElement('button');
  duplicateBtn.className = 'tool';
  duplicateBtn.textContent = 'üìã Duplicate';
  duplicateBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    duplicateItem(wrapper);
  });
  
  const forwardBtn = document.createElement('button');
  forwardBtn.className = 'tool';
  forwardBtn.textContent = '‚¨ÜÔ∏è Forward';
  forwardBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    bringForward(wrapper);
  });
  
  const backwardBtn = document.createElement('button');
  backwardBtn.className = 'tool';
  backwardBtn.textContent = '‚¨áÔ∏è Back';
  backwardBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    sendBackward(wrapper);
  });
  
  toolbar.appendChild(deleteBtn);
  toolbar.appendChild(duplicateBtn);
  toolbar.appendChild(forwardBtn);
  toolbar.appendChild(backwardBtn);
  
  wrapper.appendChild(img);
  wrapper.appendChild(toolbar);
  overlay.appendChild(wrapper);
  
  // Make interactive
  makeItemInteractive(wrapper);
  
  // Select the new item
  selectItem(wrapper);
  
  return wrapper;
}

// Update transform based on dataset values
function updateTransform(wrapper) {
  const tx = parseFloat(wrapper.dataset.tx || 0);
  const ty = parseFloat(wrapper.dataset.ty || 0);
  // Support both legacy 'scale' and new non-proportional scaleX/scaleY
  const legacyScale = parseFloat(wrapper.dataset.scale || 1);
  const scaleX = parseFloat(wrapper.dataset.scaleX || legacyScale || 1);
  const scaleY = parseFloat(wrapper.dataset.scaleY || legacyScale || 1);
  const rotation = parseFloat(wrapper.dataset.rotation || 0);
  
  wrapper.style.transform = `translate(-50%, -50%) translate(${tx}px, ${ty}px) scale(${scaleX}, ${scaleY}) rotate(${rotation}deg)`;
}

// Select item
function selectItem(wrapper) {
  // Deselect all items
  document.querySelectorAll('.item-wrap').forEach(item => {
    item.classList.remove('selected');
  });
  
  // Select this item
  wrapper.classList.add('selected');
  selectedItem = wrapper;
}

// Make item interactive
function makeItemInteractive(wrapper) {
  const img = wrapper.querySelector('.item-img');
  
  // Click to select
  wrapper.addEventListener('click', (e) => {
    e.stopPropagation();
    selectItem(wrapper);
  });
  
  // Double click to delete
  wrapper.addEventListener('dblclick', (e) => {
    e.stopPropagation();
    wrapper.remove();
    if (selectedItem === wrapper) {
      selectedItem = null;
    }
  });
  
  // Drag functionality
  let isDragging = false;
  let dragStartX, dragStartY;
  let startTx, startTy;
  
  wrapper.addEventListener('mousedown', (e) => {
    if (e.target.classList.contains('handle') || e.target.classList.contains('tool')) return;
    
    isDragging = true;
    dragStartX = e.clientX;
    dragStartY = e.clientY;
    startTx = parseFloat(wrapper.dataset.tx || 0);
    startTy = parseFloat(wrapper.dataset.ty || 0);
    
    selectItem(wrapper);
    e.preventDefault();
  });
  
  document.addEventListener('mousemove', (e) => {
    if (!isDragging || selectedItem !== wrapper) return;
    
    const dx = e.clientX - dragStartX;
    const dy = e.clientY - dragStartY;
    
    wrapper.dataset.tx = startTx + dx;
    wrapper.dataset.ty = startTy + dy;
    updateTransform(wrapper);
  });
  
  document.addEventListener('mouseup', () => {
    isDragging = false;
  });
  
  // Handle resize and rotate
  wrapper.querySelectorAll('.handle').forEach(handle => {
    handle.addEventListener('mousedown', (e) => {
      e.stopPropagation();
      
      if (handle.classList.contains('rotate')) {
        startRotate(e, wrapper);
      } else {
        startResize(e, wrapper, handle);
      }
    });
  });
  
  // Wheel to zoom (uniform)
  wrapper.addEventListener('wheel', (e) => {
    e.preventDefault();
    if (selectedItem !== wrapper) return;
    
    const scaleFactor = e.deltaY > 0 ? 0.95 : 1.05;
    const currentScaleX = parseFloat(wrapper.dataset.scaleX || wrapper.dataset.scale || 1);
    const currentScaleY = parseFloat(wrapper.dataset.scaleY || wrapper.dataset.scale || 1);
    const newScaleX = Math.max(0.05, Math.min(6, currentScaleX * scaleFactor));
    const newScaleY = Math.max(0.05, Math.min(6, currentScaleY * scaleFactor));
    
    wrapper.dataset.scaleX = newScaleX;
    wrapper.dataset.scaleY = newScaleY;
    wrapper.dataset.scale = ((newScaleX + newScaleY) / 2).toString();
    updateTransform(wrapper);
  });
}

// Start resize (with stretch support, rotation-aware)
function startResize(e, wrapper, handle) {
  e.preventDefault();
  const startX = e.clientX;
  const startY = e.clientY;

  const startScaleX = parseFloat(wrapper.dataset.scaleX || wrapper.dataset.scale || 1);
  const startScaleY = parseFloat(wrapper.dataset.scaleY || wrapper.dataset.scale || 1);
  const baseW = parseFloat(wrapper.dataset.baseWidth || 200);
  const baseH = parseFloat(wrapper.dataset.baseHeight || (baseW * 0.6));
  const startWidth = baseW * startScaleX;
  const startHeight = baseH * startScaleY;

  const rotation = parseFloat(wrapper.dataset.rotation || 0);
  const rad = rotation * Math.PI / 180;
  const cos = Math.cos(rad);
  const sin = Math.sin(rad);

  function onMouseMove(ev) {
    const dx = ev.clientX - startX;
    const dy = ev.clientY - startY;

    // Convert global delta into local coordinates relative to rotated item's axes
    const localDx = dx * cos + dy * sin;
    const localDy = -dx * sin + dy * cos;

    let newWidth = startWidth;
    let newHeight = startHeight;

    if (handle.classList.contains('e')) {
      newWidth = startWidth + localDx;
    } else if (handle.classList.contains('w')) {
      newWidth = startWidth - localDx;
    } else if (handle.classList.contains('s')) {
      newHeight = startHeight + localDy;
    } else if (handle.classList.contains('n')) {
      newHeight = startHeight - localDy;
    } else {
      // Corners => proportional by base aspect ratio
      const aspect = baseW / baseH;
      const horiz = (handle.classList.contains('e') || handle.classList.contains('ne') || handle.classList.contains('se')) ? localDx : -localDx;
      newWidth = startWidth + horiz;
      newHeight = newWidth / aspect;
    }

    // Clamp sizes
    const MIN = 20;
    if (newWidth < MIN) newWidth = MIN;
    if (newHeight < MIN) newHeight = MIN;

    // Update scales relative to base dims
    wrapper.dataset.scaleX = (newWidth / baseW).toString();
    wrapper.dataset.scaleY = (newHeight / baseH).toString();
    wrapper.dataset.scale = ((parseFloat(wrapper.dataset.scaleX) + parseFloat(wrapper.dataset.scaleY)) / 2).toString();

    updateTransform(wrapper);
  }

  function onMouseUp() {
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup', onMouseUp);
  }

  document.addEventListener('mousemove', onMouseMove);
  document.addEventListener('mouseup', onMouseUp);
}

function startRotate(e, wrapper) {
  const rect = wrapper.getBoundingClientRect();
  const centerX = rect.left + rect.width / 2;
  const centerY = rect.top + rect.height / 2;

  const startAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
  const startRotation = parseFloat(wrapper.dataset.rotation || 0);

  function onMouseMove(e) {
    const currentAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
    const deltaAngle = (currentAngle - startAngle) * (180 / Math.PI);

    wrapper.dataset.rotation = startRotation + deltaAngle;
    updateTransform(wrapper);
  }

  function onMouseUp() {
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup', onMouseUp);
  }

  document.addEventListener('mousemove', onMouseMove);
  document.addEventListener('mouseup', onMouseUp);
}

// Duplicate item (each duplicate can duplicate itself)
function duplicateItem(wrapper) {
  const newItem = wrapper.cloneNode(true);
  const currentTx = parseFloat(wrapper.dataset.tx || 0);
  const currentTy = parseFloat(wrapper.dataset.ty || 0);

  // Offset the duplicate slightly
  newItem.dataset.tx = currentTx + 30;
  newItem.dataset.ty = currentTy + 30;
  newItem.dataset.id = `item-${++itemCounter}`;

  // If clone lacks baseWidth/baseHeight (rare), copy from original
  if (!newItem.dataset.baseWidth) newItem.dataset.baseWidth = wrapper.dataset.baseWidth || 200;
  if (!newItem.dataset.baseHeight) newItem.dataset.baseHeight = wrapper.dataset.baseHeight || (parseFloat(newItem.dataset.baseWidth) * 0.6);

  // Ensure scaleX/scaleY copied
  newItem.dataset.scaleX = wrapper.dataset.scaleX || wrapper.dataset.scale || 1;
  newItem.dataset.scaleY = wrapper.dataset.scaleY || wrapper.dataset.scale || 1;
  newItem.dataset.rotation = wrapper.dataset.rotation || 0;

  overlay.appendChild(newItem);
  updateTransform(newItem);

  // Rebind toolbar + handles
  makeItemInteractive(newItem);

  // Select the duplicate
  selectItem(newItem);
}

// Z-order functions
function bringForward(wrapper) {
  const nextSibling = wrapper.nextElementSibling;
  if (nextSibling) {
    wrapper.parentNode.insertBefore(nextSibling, wrapper);
  }
}

function sendBackward(wrapper) {
  const prevSibling = wrapper.previousElementSibling;
  if (prevSibling) {
    wrapper.parentNode.insertBefore(wrapper, prevSibling);
  }
}

// Snapshot functionality
snapshotBtn.addEventListener('click', async () => {
  // Create canvas with camera wrapper dimensions
  const rect = cameraWrapper.getBoundingClientRect();
  const canvas = document.createElement('canvas');
  canvas.width = rect.width;
  canvas.height = rect.height;
  const ctx = canvas.getContext('2d');
  
  // Draw background (camera or uploaded image)
  if (useBackground && bgImage.src && bgImage.style.display !== 'none') {
    // Draw background image
    await new Promise((resolve) => {
      const img = new Image();
      img.onload = () => {
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        resolve();
      };
      img.src = bgImage.src;
    });
  } else if (camera.style.display !== 'none' && camera.videoWidth > 0) {
    // Draw video frame
    ctx.drawImage(camera, 0, 0, canvas.width, canvas.height);
  } else {
    // White background
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }
  
  // Draw grid if visible
  if (gridVisible) {
    const gridSize = 40;
    ctx.strokeStyle = 'rgba(15, 23, 42, 0.1)';
    ctx.lineWidth = 1;
    
    for (let x = 0; x < canvas.width; x += gridSize) {
      ctx.beginPath();
      ctx.moveTo(x, 0);
      ctx.lineTo(x, canvas.height);
      ctx.stroke();
    }
    
    for (let y = 0; y < canvas.height; y += gridSize) {
      ctx.beginPath();
      ctx.moveTo(0, y);
      ctx.lineTo(canvas.width, y);
      ctx.stroke();
    }
  }
  
  // Draw all furniture items
  const items = Array.from(overlay.querySelectorAll('.item-wrap'));
  
  for (const item of items) {
    const img = item.querySelector('.item-img');
    if (!img) continue;
    
    await new Promise((resolve) => {
      const image = new Image();
      image.onload = () => {
        // Get item position and transform
        const itemRect = item.getBoundingClientRect();
        const cameraRect = cameraWrapper.getBoundingClientRect();
        
        // Position relative to camera wrapper
        const x = itemRect.left - cameraRect.left;
        const y = itemRect.top - cameraRect.top;
        const width = itemRect.width;
        const height = itemRect.height;
        
        const centerX = x + width / 2;
        const centerY = y + height / 2;
        
        // Apply transforms
        const rotation = parseFloat(item.dataset.rotation || 0) * (Math.PI / 180);
        
        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate(rotation);
        ctx.drawImage(image, -width / 2, -height / 2, width, height);
        ctx.restore();
        
        resolve();
      };
      image.onerror = () => resolve();
      image.src = img.src;
    });
  }
  
  // Download the image
  const link = document.createElement('a');
  link.download = `furniture-tryon-${Date.now()}.png`;
  link.href = canvas.toDataURL('image/png');
  link.click();
});

// Click outside to deselect
document.addEventListener('click', (e) => {
  if (!overlay.contains(e.target) && selectedItem) {
    selectedItem.classList.remove('selected');
    selectedItem = null;
  }
  
  // Close catalog if clicking outside
  if (catalogDrawer.classList.contains('open') && 
      !catalogDrawer.contains(e.target) && 
      !catalogToggle.contains(e.target)) {
    catalogDrawer.classList.remove('open');
    catalogDrawer.setAttribute('aria-hidden', 'true');
  }
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (!selectedItem) return;
  
  switch (e.key) {
    case 'Delete':
    case 'Backspace':
      selectedItem.remove();
      selectedItem = null;
      break;
    case 'd':
    case 'D':
      if (e.ctrlKey || e.metaKey) {
        e.preventDefault();
        duplicateItem(selectedItem);
      }
      break;
    case 'ArrowUp':
      if (e.shiftKey) {
        bringForward(selectedItem);
      } else {
        const currentTy = parseFloat(selectedItem.dataset.ty || 0);
        selectedItem.dataset.ty = currentTy - 5;
        updateTransform(selectedItem);
      }
      e.preventDefault();
      break;
    case 'ArrowDown':
      if (e.shiftKey) {
        sendBackward(selectedItem);
      } else {
        const currentTy = parseFloat(selectedItem.dataset.ty || 0);
        selectedItem.dataset.ty = currentTy + 5;
        updateTransform(selectedItem);
      }
      e.preventDefault();
      break;
    case 'ArrowLeft':
      const currentTx = parseFloat(selectedItem.dataset.tx || 0);
      selectedItem.dataset.tx = currentTx - 5;
      updateTransform(selectedItem);
      e.preventDefault();
      break;
    case 'ArrowRight':
      const currentTxRight = parseFloat(selectedItem.dataset.tx || 0);
      selectedItem.dataset.tx = currentTxRight + 5;
      updateTransform(selectedItem);
      e.preventDefault();
      break;
  }
});

// Initialize everything
window.addEventListener('load', () => {
  initCatalog();
  drawGrid(false);
  
  // Handle window resize
  window.addEventListener('resize', () => {
    if (gridVisible) {
      drawGrid(true);
    }
  });
});

// Touch support for mobile
let touchStartData = {};

overlay.addEventListener('touchstart', (e) => {
  const touch = e.touches[0];
  const target = document.elementFromPoint(touch.clientX, touch.clientY);
  const wrapper = target && target.closest('.item-wrap');
  
  if (wrapper) {
    touchStartData = {
      wrapper,
      startX: touch.clientX,
      startY: touch.clientY,
      startTx: parseFloat(wrapper.dataset.tx || 0),
      startTy: parseFloat(wrapper.dataset.ty || 0)
    };
    selectItem(wrapper);
    e.preventDefault();
  }
});

overlay.addEventListener('touchmove', (e) => {
  if (!touchStartData.wrapper) return;
  
  const touch = e.touches[0];
  const dx = touch.clientX - touchStartData.startX;
  const dy = touch.clientY - touchStartData.startY;
  
  touchStartData.wrapper.dataset.tx = touchStartData.startTx + dx;
  touchStartData.wrapper.dataset.ty = touchStartData.startTy + dy;
  updateTransform(touchStartData.wrapper);
  
  e.preventDefault();
});

overlay.addEventListener('touchend', () => {
  touchStartData = {};
});

</script>
</body>
</html>
